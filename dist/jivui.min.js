/*! (c) 2016 Ignacio X. DomÃ­nguez (MIT) */
function JIVUIEngineFactory(){var t=!1,e=null,n=null,o=0,r=0,a=0,i=1;return{isActive:function(){return t},start:function(){t||(t=!0,r=0,o=Date.now(),a=Date.now(),this.tick(i))},tick:function(u){var s=this;e=setTimeout(function(){var e=Date.now();r+=i;var u=e-a-r,c=u>0?Math.round(u/i):0;r+=c*i,o=e,n(c),t&&s.tick(i-u)},u)},addTickHandler:function(t){n=t},stop:function(){return o=0,t=!1,clearTimeout(e),e=null,Date.now()-a},getFPS:function(){return Math.round(1e3/i)},setFPS:function(t){t>1e3?t=1e3:1>t&&(t=1),i=1e3/t}}}function JIVUIPluginManagerFactory(){function t(t,e){var n=new XMLHttpRequest;n.onreadystatechange=function(){4==n.readyState&&n.status>=200&&n.status<400?e(n.responseText):4==n.readyState&&console.warn("Could not load resource: "+t,n.status)},n.open("GET",t,!1),n.send()}function e(e){console.log("loading: ''"+e.path+"/jivuiplugin.json'"),t(e.path+"/jivuiplugin.json",function(a){a=JSON.parse(a),"ui"==a.type||"both"==a.type?(a.template?t(e.path+"/"+a.template,function(t){e.element.innerHTML=t,n(e.element,e.path+"/"),o(e.path,a.src)}):o(e.path,a.src),r(e.path,a.style)):o(e.path,a.src)})}function n(t,n){n="undefined"!=typeof n?n:"";for(var o=t.querySelectorAll("[data-jivui]"),r=0;r<o.length;r++)e({element:o[r],path:n+o[r].getAttribute("data-jivui")})}function o(t,e){e&&(Array.isArray(e)?e.forEach(function(e,n){a(t,e)}):a(t,e))}function r(t,e){if(e){var n=i(e)?e:t+"/"+e,o=document.createElement("link");o.setAttribute("rel","stylesheet"),o.setAttribute("type","text/css"),o.setAttribute("href",n),document.body.appendChild(o)}}function a(t,e){if(e){var n=i(e)?e:t+"/"+e,o=document.createElement("script");o.async=!1,o.setAttribute("type","text/javascript"),o.setAttribute("src",n),document.head.appendChild(o)}}function i(t){var e=/^https?:\/\//i;return e.test(t)}var u=[],s=[],c={loadPlugins:n,addPlugin:function(t,e){"preprocessor"==e?u.push(t):"ui"==e&&s.push(t)},getPreprocessors:function(){return u},getUIModules:function(){return s}};return c}JIVUIPluginManagerFactory.Preprocessor=function(){return{onDataLoaded:function(t,e){}}},JIVUIPluginManagerFactory.UIModule=function(){return{state:null,setStateManager:function(t){this.state=t},init:function(t){},onDataProcessed:function(t,e){},onPlay:function(){},onPause:function(){},onStop:function(){},onFPS:function(t){},onFrame:function(t,e){},onScrub:function(t){}}};var JIVUI=function(){function t(t){var e=0,n=0,o=0,r=0,i=u.getUIModules(!0);for(e=0,r=t+1;r>e;++e){for(n=0,o=i.length;o>n;++n)i[n].onFrame(s,a.data[s]);if(s++,a&&a.settings.end<=s){c.stop();break}}}function e(t){c.stop(),a=t;var e,n=u.getPreprocessors();for(e=0;e<n.length;e++)n[e].onDataLoaded(a.settings,a.data);var o=u.getUIModules();for(e=0;e<o.length;e++)o[e].onDataProcessed(a.settings,a.data)}function n(){return a}function o(t){u.addPlugin(t,"preprocessor")}function r(t){t.setStateManager(c),u.addPlugin(t,"ui"),t.init(c)}var a=null,i=new JIVUIEngineFactory;i.addTickHandler(t);var u=new JIVUIPluginManagerFactory,s=0,c={getData:function(){return a},getFPS:function(){return i.getFPS()},setFPS:function(t){i.setFPS(t);for(var e=u.getUIModules(),n=0;n<e.length;n++)e[n].onFPS(i.getFPS())},setFrame:function(t){s=t;for(var e=u.getUIModules(),n=0;n<e.length;n++)e[n].onScrub(s)},isPlaying:function(){return i.isActive()},play:function(){if(!i.isActive()&&a){for(var t=u.getUIModules(),e=0;e<t.length;e++)t[e].onPlay();i.start()}},pause:function(){for(var t=u.getUIModules(),e=0;e<t.length;e++)t[e].onPause();i.stop()},stop:function(){s=a?a.settings.start:0;for(var t=u.getUIModules(),e=0;e<t.length;e++)t[e].onStop();i.stop(),this.setFrame(s)}};document.addEventListener("DOMContentLoaded",function(){u.loadPlugins(document),console.log("DOMContentLoaded")});var l={getDataset:n,setDataset:e,registerPreprocessor:o,registerUIModule:r,Preprocessor:JIVUIPluginManagerFactory.Preprocessor,UIModule:JIVUIPluginManagerFactory.UIModule};return l}();JIVUI.saveData=function(){var t=JIVUI.getDataset();if(t){var e=document.createElement("a"),n=t.title+".json";return e.setAttribute("href","data:text/json;charset=utf-8,"+encodeURIComponent(JSON.stringify(t))),e.setAttribute("download",n),e.style.display="none",document.body.appendChild(e),e.click(),document.body.removeChild(e),!1}},JIVUI.loadData=function(){var t=document.createElement("input");return t.setAttribute("type","file"),t.addEventListener("change",function(t){var e=t.target.files[0];if(e){var n=new FileReader;n.onload=function(t){var e=t.target.result;JIVUI.setDataset(JSON.parse(e))},n.readAsText(e)}},!1),t.style.display="none",document.body.appendChild(t),t.click(),setTimeout(function(){document.body.removeChild(t)},5e3),!1};